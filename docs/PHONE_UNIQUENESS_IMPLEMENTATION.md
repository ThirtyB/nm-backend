# 手机号唯一性实现说明

## 需求描述

实现用户手机号的唯一性约束，确保一个手机号只能被一个用户使用。由于手机号在数据库中是加密存储的，无法直接使用数据库的UNIQUE约束，需要通过应用层逻辑实现。

## 实现方案

### 1. 创建手机号验证工具

**文件**: `app/utils/phone_validation.py`

提供了三个核心函数：

#### `check_phone_unique(db, phone, exclude_user_id=None)`
- **功能**: 检查手机号是否唯一
- **参数**: 
  - `db`: 数据库会话
  - `phone`: 要检查的手机号
  - `exclude_user_id`: 排除的用户ID（用于更新时排除自己）
- **返回**: `True`表示唯一或为空，`False`表示手机号已存在

#### `get_all_phone_numbers(db)`
- **功能**: 获取所有用户的解密手机号列表
- **返回**: 手机号字符串列表

#### `find_user_by_phone(db, phone)`
- **功能**: 根据手机号查找用户
- **返回**: 找到的用户对象或None

### 2. 修改各个接口

#### 用户注册接口 (`app/routers/auth.py`)
- **位置**: `/auth/register`
- **修改**: 在创建新用户或重新激活用户前检查手机号唯一性
- **错误码**: 400，错误信息: "Phone number already registered"

#### 管理员创建用户接口 (`app/routers/users.py`)
- **位置**: `POST /users/`
- **修改**: 在创建用户或重新激活用户前检查手机号唯一性

#### 管理员更新用户接口 (`app/routers/users.py`)
- **位置**: `PUT /users/{user_id}` 和 `PATCH /users/{user_id}`
- **修改**: 在更新手机号前检查唯一性，排除当前用户

#### 用户个人资料更新接口 (`app/routers/user_profile.py`)
- **位置**: `PUT /profile/phone`
- **修改**: 在用户更新自己手机号前检查唯一性，排除当前用户

#### 用户列表接口 (`app/routers/users.py`)
- **位置**: `GET /users/`
- **修改**: 添加 `order_by(User.id)` 确保按ID排序返回

## 性能考虑

### 当前方案的优缺点

**优点**:
- 实现简单，易于理解和维护
- 支持加密手机号的唯一性检查
- 支持更新时排除自己的逻辑

**缺点**:
- 需要读取所有用户并解密手机号，性能较差
- 随着用户数量增加，查询时间会线性增长

### 性能优化建议

1. **缓存优化**: 可以将手机号映射关系缓存到Redis中
2. **哈希索引**: 维护一个手机号哈希值的索引表，用于快速判断重复
3. **定期同步**: 定期将加密手机号同步到哈希索引表

## 错误处理

### 解密失败处理
在手机号验证过程中，如果某个用户的手机号解密失败，会跳过该用户继续检查其他用户。这确保了解密错误不会影响整个唯一性检查流程。

### 空手机号处理
- 空字符串或None的手机号不需要检查唯一性
- 允许多个用户不设置手机号

## 测试用例

**文件**: `test/test_phone_uniqueness.py`

包含以下测试场景：

1. **注册时手机号重复测试**
   - 第一个用户使用某手机号注册成功
   - 第二个用户使用相同手机号注册失败

2. **更新时手机号重复测试**
   - 两个用户使用不同手机号
   - 尝试将一个用户的手机号更新为另一个用户的手机号（失败）
   - 更新为新手机号（成功）

3. **用户列表排序测试**
   - 验证用户列表按ID升序排列

## 使用示例

### API调用示例

#### 注册用户（带手机号检查）
```bash
curl -X POST "http://localhost:8000/auth/register" \
     -H "Content-Type: application/json" \
     -d '{
       "username": "newuser",
       "password": "password123",
       "phone": "13800138000"
     }'
```

如果手机号已存在，返回：
```json
{
  "detail": "Phone number already registered"
}
```

#### 更新用户手机号
```bash
curl -X PUT "http://localhost:8000/users/1" \
     -H "Authorization: Bearer <admin_token>" \
     -H "Content-Type: application/json" \
     -d '{
       "phone": "13900139000"
     }'
```

## 注意事项

1. **性能影响**: 当前实现方案在用户数量较大时可能存在性能问题
2. **并发安全**: 在高并发场景下，可能需要添加数据库锁或其他并发控制机制
3. **数据一致性**: 确保手机号加密/解密的一致性
4. **向后兼容**: 保持对现有API的兼容性

## 后续优化方向

1. 实现手机号哈希索引表
2. 添加Redis缓存层
3. 实现分布式锁机制
4. 添加手机号格式验证和标准化
5. 支持批量手机号唯一性检查